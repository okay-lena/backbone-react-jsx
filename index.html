<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Recipes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
  <link href='https://fonts.googleapis.com/css?family=Courgette' rel='stylesheet'>
  <link rel="stylesheet/less" type="text/css" href="styles/style.less" />
  <script>
    less = {
      env: "development",
      async: false,
      fileAsync: false,
      poll: 1000,
      functions: {},
      dumpLineNumbers: "comments",
      relativeUrls: false,
      rootpath: ":/a.com/"
    };
  </script>
  <script src="less.js" type="text/javascript"></script>
  <link rel="stylesheet" href="./styles/style.css">
</head>
<body>
  <section id="app">
    <header id="header">
      <a href="/project-backbone" class="appTitle"><h1>May I have...</h1></a>
      <input id="search-recipe" class="searchForm" placeholder="Search a recipe here" autofocus/>
    </header>
    <section id="main">
      <ul id="recipe-list" class="recipeList"></ul>
    </section>
  </section>

  <!--  templates-->
  <script type="text/template" id="recipe-template">
    <div class="view">
      <h3 class="recipeTitle" id="<%- id %>"><a href="recipe/<%- title %>"></a><%- title %></a></h3>
      <span class="recipeId" style="display: none"><%- id %></span>
      <span class="cooktime">Ready in <%- readyInMinutes %> minutes</span>
      <span class="imgInListWrapper">
        <img src="https://spoonacular.com/recipeImages/<%- image %>" alt="<%- title %>">
      </span>
    </div>
  </script>


  <script type="text/template" id="recipe-details">
    <div class="recipeDetails">
      <h1 class="recipeTitle"><%- title %></h1>
      <span class="servings">Servings: <%- servings %></span>
      <span class="creditSource">
        Credit:&nbsp;<a href="<%- sourceUrl %>"><%- sourceUrl %></a>
      </span>
      <span class="preparationTime">Preparation time: <%- preparationMinutes %> min.</span>
      <span class="cookingTime">Cooking time: <%- cookingMinutes %> min.</span>
      <span class="imgDetailsWrapper">
        <img class="imgDetails" src="<%- image %>" alt="<%- title %>"/>
      </span>
      <span class="instructions"><%- instructions %></span>
    </div>
  </script>

<!-- libs-->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"
          type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.0/backbone-min.js"
          integrity="sha256-OO+KD/bMG3Dr57LO27ZhYL2zYhLP1CJIkCXUUDnFNuc="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.16/backbone.localStorage-min.js"
          integrity="sha256-FuGTIy5WQ/azIw7nWerH7B+30pfMyQU9J3jROXWP9ME="
          crossorigin="anonymous"></script>

  <script type="text/javascript">
    // models

    const Recipe = Backbone.Model.extend({
      defaults: {
        "id": null,
        "image": "",
        "imageUrls": [
          ""
        ],
        "readyInMinutes": null,
        "servings": null,
        "title": ""
      }
    })

    const RecipeDetails = Backbone.Model.extend({
      defaults: {
        "id": null,
        "title": "",
        "sourceUrl": "",
        "servings": null,
        "preparationMinutes": null,
        "cookingMinutes": null,
        "readyInMinutes": null,
        "image": "",
        "instructions": "",
      }
    })

    // collections

    const RecipeList = Backbone.Collection.extend({
      model: Recipe,
      localStorage: new Store("backbone-recipes")
    });

    // instance of the Collection
    const recipeList = new RecipeList()

    // event aggregator
    const eventAggregator = _.extend({}, Backbone.Events)

    // views

    // renders individual recipe item (li)
    const RecipeView = Backbone.View.extend({
      tagName: 'li',
      id: 'recipe-list',
      template: _.template($('#recipe-template').html()),
      render: function(){
        this.$el.html(this.template(this.model.toJSON()))
        return this // enable chained calls
      },
      events: {
        'click .view': function (e) {
          console.log('clicked', e)
          // console.log('clicked id is ', e.target.children[1].innerHTML)
          eventAggregator.trigger('recipe:selected', this.model)
        }
      },
    })

    const RecipeDetailsView = Backbone.View.extend({
      id: 'recipeDetails',
      model: RecipeDetails,
      template: _.template($('#recipe-details').html()),
      render: function(){
        this.$el.html(this.template(this.model.toJSON()))
        return this // enable chained calls
      },
    })

    // renders the full list of recipes calling RecipeView for each one
    const AppView = Backbone.View.extend({
      el: '#app',

      initialize: function(i) {
        console.log('App View initialize', i)
        this.input = this.$('#search-recipe')
        recipeList.on('reset', this.cleanupCollection, this)
        recipeList.on('add', this.addAllRecipesToCollection, this)
        this.render()
      },

      cleanupCollection: function(collection){
        console.log(`Inside cleanupCollection, got `, collection)
        // clean the recipe list
        this.$('#recipe-list').html('')
      },

      addAllRecipesToCollection: function(recipe){
        console.log("Got model inside addAllRecipesToCollection", recipe)
        const view = new RecipeView({model: recipe})
        $('#recipe-list').append(view.render().el)
      },

      events: {
        'keypress #search-recipe': 'searchRecipesOnEnter'
      },

      searchRecipesOnEnter: function(event) {
        const query = event.target.value.trim()
        if (event.keyCode === 13 && query) {
          // should search recipes using API
          $.ajax({
            url: `https://api.spoonacular.com/recipes/search?apiKey=82de3f92015a4978a427335171c863a4&number=6&query=${query}`,
            success: function (response) {
              // remove recipe details is any
              $('#recipeDetails').remove()
              // clear input
              $("#search-recipe").val("");


              console.log('recipes fetch result: \n', response.results)
              // reset recipes in collection if any
              recipeList.reset(Recipe, null)

              // display recipes results in #recipe-list
              const recipesFetched = _.map(response.results, function(recipe){
                const recipeItem = new Recipe(recipe)
                console.log('recipe item: ', recipeItem)
                return recipeItem
              })
              console.log('recipes', recipesFetched)
              // trigger 'add' event in AppView
              recipeList.add(recipesFetched)
              console.log('All new models have been added to the collection')
              recipeList.trigger('update')
              // hide recipes collection
              $("#recipe-list").show()
            },
            error: function (xhr) {
              alert("An error occurred: " + xhr.status + " " + xhr.statusText)
            }
          })
        }
      },
    })

    // Routes
    const Router = Backbone.Router.extend({
      routes: {
        'search' : 'showSearchForm',
        'recipe/:title' : 'showRecipe'
      },

      showSearchForm: function() {
        $("#app").show()
        console.log('Show search form worked')
      },

      showRecipe: function(title) {
        //console.log('router.params title = ' + title)
        // getting list of model instances from collection
        const listOfRecipes = recipeList.models
        const selectedRecipe = _.find(listOfRecipes, function (recipe) {
          //console.log('recipe in find', recipe)
          //console.log('recipe list in find ', recipeList)
          return recipe.get('title') === title
        })
        //console.log('selected recipe', selectedRecipe)
        console.log('selected recipe ID ', selectedRecipe.id)

        // fetch from API recipe detailed information to display it on recipe details page
        const getRecipeInfo = (function() {
          const id = selectedRecipe.id
          $.ajax({
            url: `https://api.spoonacular.com/recipes/${id}/information?apiKey=82de3f92015a4978a427335171c863a4`,
            success: function (response) {
              console.log('recipe info fetch response - \n', response)
              const selectedRecipeInfo = new RecipeDetails(response)
              console.log('recipe info', selectedRecipeInfo)

              // hide recipes collection
              $("#recipe-list").hide()

              // remove recipe details if any
              $('#recipeDetails').remove()

              // show recipe details template
              $('#main').append(new RecipeDetailsView({model: selectedRecipeInfo}).render().el)
              //return response
            },
            error: function (xhr) {
              alert("An error occurred: " + xhr.status + " " + xhr.statusText)
            }
          })
        })()

      }
    })

    eventAggregator.on('recipe:selected', function (recipe) {
      const urlPath = 'recipe/' + recipe.get('title')
      router.navigate(urlPath, {trigger: true})
    })

    // initialize router
    const router = new Router()
    Backbone.history.start()
    router.navigate('search', {trigger: true})

    // initialize app view
    const appView = new AppView()

  </script>

</body>
</html>